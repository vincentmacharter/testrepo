pipeline {
    agent any 
    stages {
        stage('Build'){
            steps{
                echo 'Starting up eureka cluster...'
                sh 'pwd'
                sh 'kubectl config --kubeconfig=config-new use-context platform-test-eureka'
                sh 'kubectl config --kubeconfig=config-new current-context'
                sh 'kubectl --kubeconfig=config-new apply -f testrepo/eureka1-headless-service.yaml'
                sh 'kubectl --kubeconfig=config-new apply -f testrepo/eureka1-service.yaml'
                sh 'kubectl --kubeconfig=config-new apply -f testrepo/eureka2-service.yaml'
                sh 'kubectl --kubeconfig=config-new apply -f testrepo/eureka3-service.yaml'
                sh 'kubectl --kubeconfig=config-new apply -f testrepo/eureka1-sts.yaml'
                sh 'kubectl --kubeconfig=config-new -n eurekatest-vincent get pods'
                sh 'kubectl --kubeconfig=config-new -n eurekatest-vincent get services'
            }

        }

        stage('DNS Assignment') {
            steps {
                echo 'Assigning DNS to k8s services...'
                echo 'Assigning DNS to eureka1 service...'
                sh 'testrepo/update-public-ip-dns.sh eureka3 eurekatest-vincent eureka3svc'
                echo 'DNS assignment to service eureka1 complete'

                echo 'Assigning DNS to eureka2 service...'
                sh 'testrepo/update-public-ip-dns.sh eureka2 eurekatest-vincent eureka2svc'
                echo 'DNS assignment to service eureka2 complete'

                echo 'Assigning DNS to eureka3 service...'
                sh 'testrepo/update-public-ip-dns.sh eureka3 eurekatest-vincent eureka3svc'
                echo 'DNS assignment to service eureka3 complete'

                echo 'DNS Assignment complete'
            }
        }
    }
}
